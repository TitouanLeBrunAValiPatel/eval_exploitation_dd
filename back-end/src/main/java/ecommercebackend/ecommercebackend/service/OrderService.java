package ecommercebackend.ecommercebackend.service;

import ecommercebackend.ecommercebackend.data.entity.database.*;
import ecommercebackend.ecommercebackend.data.repository.ColorRepository;
import ecommercebackend.ecommercebackend.data.repository.OrderProductRepository;
import ecommercebackend.ecommercebackend.data.repository.OrderRepository;
import ecommercebackend.ecommercebackend.data.repository.ProductRepository;
import ecommercebackend.ecommercebackend.dto.CardDTO;
import ecommercebackend.ecommercebackend.dto.OrderDTO;
import ecommercebackend.ecommercebackend.dto.UserDTO;
import ecommercebackend.ecommercebackend.dto.mapper.MapstructMapper;
import ecommercebackend.ecommercebackend.dto.mapper.ProductMapper;
import ecommercebackend.ecommercebackend.dto.product.OrderAndCartProductDTO;
import ecommercebackend.ecommercebackend.exception.InvalidIdException;
import ecommercebackend.ecommercebackend.exception.NotfoundException;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Service
@RequiredArgsConstructor
public class OrderService implements CrudService<OrderDTO> {

    private final OrderRepository orderRepository;
    private final OrderProductRepository orderProductRepository;
    private final ProductMapper productMapper;
    private final UserService userService;
    private final CardService cardService;
    private final ProductRepository productRepository;
    private final ColorRepository colorRepository;


    @Override
    public List<OrderDTO> getAllItem() {
        return MapstructMapper.INSTANCE.orderToOrderDTO(orderRepository.findAll());
    }

    public List<OrderDTO> getAllItemByUserId(int userId) throws Exception {
        userService.getItemById(userId);
        List<Order> orders = orderRepository.findAllByUserId(userId);
        List<OrderDTO> orderDTOS = new ArrayList<>();
        for (Order order : orders) {
            OrderDTO orderDTO = findOrderDTO(order, order.getId());
            orderDTO.setCardDTO(null);
            orderDTO.setUserDTO(null);
            orderDTO.setOrderAndCartProductDTOS(null);
            orderDTOS.add(orderDTO);
        }
        return orderDTOS;
    }

    @Override
    public OrderDTO getItemById(int id) throws InvalidIdException, NotfoundException {
        Order order = orderRepository.findById(id).orElseThrow(() -> new NotfoundException(Category.class));
        return findOrderDTO(order, id);
    }

    @Override
    @Transactional
    public OrderDTO addItem(OrderDTO item) throws Exception {
        UserDTO userDTO = userService.getItemById(item.getUserDTO().getId());
        CardDTO cardDTO = cardService.getItemById(item.getCardDTO().getId());
        item.setUserDTO(userDTO);
        item.setCardDTO(cardDTO);
        item.setDate(new Date());
        float totalPrice = 0;
//        int totalQuantity = 0;
        for (OrderAndCartProductDTO orderAndCartProductDTO : item.getOrderAndCartProductDTOS()) {
            Product product = productRepository.findById(orderAndCartProductDTO.getId()).orElseThrow(() -> new NotfoundException(Product.class));
            totalPrice += product.getPrice() * orderAndCartProductDTO.getQuantity();
//            totalQuantity += orderAndCartProductDTO.getQuantity();
        }
        item.setTotalPrice(totalPrice);
        Order order = MapstructMapper.INSTANCE.orderDTOToOrder(item);
        orderRepository.save(order);
        for (OrderAndCartProductDTO orderAndCartProductDTO : item.getOrderAndCartProductDTOS()) {
            Product product = productRepository.findById(orderAndCartProductDTO.getId()).orElseThrow(() -> new NotfoundException(Category.class));
            Color color = colorRepository.findById(orderAndCartProductDTO.getColor().getId()).orElseThrow(() -> new NotfoundException(Color.class));
            orderProductRepository.save(new OrderProduct(order, product, color, orderAndCartProductDTO.getQuantity()));
        }
        item.setId(order.getId());
        item.setUserDTO(null);
        return item;
    }

    @Override
    public void deleteItemById(int id) {
        orderRepository.deleteById(id);
    }

    @Override
    public OrderDTO updateItem(OrderDTO item) {
        orderRepository.save(MapstructMapper.INSTANCE.orderDTOToOrder(item));
        return item;
    }

    public OrderDTO findOrderDTO(Order order, int id) throws InvalidIdException {
        if (order == null) {
            throw new InvalidIdException(Order.class, id);
        }
        List<OrderProduct> orderProducts = orderProductRepository.findAllByOrderId(id);
        List<OrderAndCartProductDTO> orderAndCartProductDTOS = new ArrayList<>();
        int numberTotalQuantity = 0;
        int numberOfArticle = 0;
        float total_price = 0;
        for (OrderProduct orderProduct : orderProducts) {
            int total = orderProduct.getQuantity() * orderProduct.getProduct().getPrice();
            orderAndCartProductDTOS.add(productMapper.productToOrderProductDTO(orderProduct, total));
            numberTotalQuantity += orderProduct.getQuantity();
            total_price += total;
            numberOfArticle++;
        }
        return MapstructMapper.INSTANCE.orderToOrderDTO(order, orderAndCartProductDTOS, numberTotalQuantity, total_price, numberOfArticle);
    }

}
