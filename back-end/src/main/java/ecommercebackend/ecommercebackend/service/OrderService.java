package ecommercebackend.ecommercebackend.service;

import ecommercebackend.ecommercebackend.data.entity.database.Order;
import ecommercebackend.ecommercebackend.data.entity.database.OrderProduct;
import ecommercebackend.ecommercebackend.data.repository.OrderProductRepository;
import ecommercebackend.ecommercebackend.data.repository.OrderRepository;
import ecommercebackend.ecommercebackend.dto.OrderDTO;
import ecommercebackend.ecommercebackend.dto.mapper.MapstructMapper;
import ecommercebackend.ecommercebackend.dto.mapper.ProductMapper;
import ecommercebackend.ecommercebackend.dto.product.OrderProductDTO;
import ecommercebackend.ecommercebackend.exception.InvalidIdException;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class OrderService implements CrudService<OrderDTO> {

    private final OrderRepository orderRepository;
    private final OrderProductRepository orderProductRepository;
    private final ProductMapper productMapper;
    private final UserService userService;
    private final CardService cardService;


    @Override
    public List<OrderDTO> getAllItem() {
        return MapstructMapper.INSTANCE.orderToOrderDTO(orderRepository.findAll());
    }

    public List<OrderDTO> getAllItemByUserId(int userId) throws InvalidIdException {
        userService.getItemById(userId);
        List<Order> orders = orderRepository.findAllByUserId(userId);
        List<OrderDTO> orderDTOS = new ArrayList<>();
        for (Order order : orders) {
            OrderDTO orderDTO = createOrderDTO(order, order.getId());
            orderDTO.setCardDTO(null);
            orderDTO.setUserDTO(null);
            orderDTO.setOrderProductDTOS(null);
            orderDTOS.add(orderDTO);
        }
        return orderDTOS;
    }

    @Override
    public OrderDTO getItemById(int id) throws InvalidIdException {
        Order order = orderRepository.findById(id);
        return createOrderDTO(order, id);
    }

    @Override
    public OrderDTO addItem(OrderDTO item) throws InvalidIdException {
        item.setUserDTO(userService.getItemById(item.getUserDTO().getId()));
        item.setCardDTO(cardService.getItemById(item.getCardDTO().getId()));

        orderRepository.save(MapstructMapper.INSTANCE.orderDTOToOrder(item));
        return item;
    }

    @Override
    public void deleteItemById(int id) {
        orderRepository.deleteById(id);
    }

    @Override
    public OrderDTO updateItem(OrderDTO item) {
        orderRepository.save(MapstructMapper.INSTANCE.orderDTOToOrder(item));
        return item;
    }

    public OrderDTO createOrderDTO(Order order, int id) throws InvalidIdException {
        if (order == null) {
            throw new InvalidIdException(Order.class, id);
        }
        List<OrderProduct> orderProducts = orderProductRepository.findAllByOrderId(id);
        List<OrderProductDTO> orderProductDTOS = new ArrayList<>();
        int numberTotalQuantity = 0;
        int numberOfArticle = 0;
        float total_price = 0;
        for (OrderProduct orderProduct : orderProducts) {
            int total = orderProduct.getQuantity() * orderProduct.getProduct().getPrice();
            orderProductDTOS.add(productMapper.productToOrderProductDTO(orderProduct, total));
            numberTotalQuantity += orderProduct.getQuantity();
            total_price += total;
            numberOfArticle++;
        }
        return MapstructMapper.INSTANCE.orderToOrderDTO(order, orderProductDTOS, numberTotalQuantity, total_price, numberOfArticle);
    }

}
