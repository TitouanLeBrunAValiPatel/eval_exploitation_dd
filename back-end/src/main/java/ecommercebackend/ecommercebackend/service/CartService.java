package ecommercebackend.ecommercebackend.service;

import ecommercebackend.ecommercebackend.data.entity.database.*;
import ecommercebackend.ecommercebackend.data.repository.*;
import ecommercebackend.ecommercebackend.dto.CartDTO;
import ecommercebackend.ecommercebackend.dto.UserDTO;
import ecommercebackend.ecommercebackend.dto.mapper.MapstructMapper;
import ecommercebackend.ecommercebackend.dto.mapper.ProductMapper;
import ecommercebackend.ecommercebackend.dto.product.OrderAndCartProductDTO;
import ecommercebackend.ecommercebackend.exception.InvalidIdException;
import ecommercebackend.ecommercebackend.exception.NotfoundException;
import jakarta.transaction.Transactional;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class CartService implements CrudService<CartDTO> {
    private final CartRepository cartRepository;
    private final UserRepository userRepository;
    private final ProductMapper productMapper;
    private final CartProductRepository cartProductRepository;
    private final ColorRepository colorRepository;
    private final ProductRepository productRepository;
    private final UserService userService;

    @Override
    public List<CartDTO> getAllItem() {
        return MapstructMapper.INSTANCE.cartDTOToCart(cartRepository.findAll());
    }

    @Override
    public CartDTO getItemById(int id) throws InvalidIdException, NotfoundException {
        Cart cart = cartRepository.findById(id).orElseThrow(() -> new NotfoundException(Category.class));
        return this.findCartDTO(cart, id);
    }

    @Override
    @Transactional
    public CartDTO addItem(CartDTO item) throws Exception {
        if (cartRepository.findCartByUserId(item.getUserDTO().getId()) != null) {
            throw new Exception("cart already exist");
        }
        User user = userRepository.findById(item.getUserDTO().getId()).orElseThrow(() -> new NotfoundException(Category.class));
        UserDTO userDTO = MapstructMapper.INSTANCE.userToUserDTO(user);
        item.setUserDTO(userDTO);
        Cart cart = cartRepository.save(MapstructMapper.INSTANCE.cartDTOToCart(item));
        List<OrderAndCartProductDTO> orderAndCartProductDTOS = new ArrayList<>();
        for (OrderAndCartProductDTO orderAndCartProductDTO : item.getOrderAndCartProductDTOS()) {
            Color color = colorRepository.findById(orderAndCartProductDTO.getColor().getId()).orElse(null);
            Product product = productRepository.findById(orderAndCartProductDTO.getId()).orElseThrow(() -> new NotfoundException(Category.class));

            CartProduct cartProduct = new CartProduct(cart, product, color, orderAndCartProductDTO.getQuantity());
            cartProductRepository.save(cartProduct);
            orderAndCartProductDTOS.add(productMapper.productToCartProductDTO(cartProduct, product.getPrice() * orderAndCartProductDTO.getQuantity()));
        }
        item.setOrderAndCartProductDTOS(orderAndCartProductDTOS);
        item.setId(cart.getId());
        return item;
    }

    @Override
    public void deleteItemById(int id) {
        cartRepository.deleteById(id);
    }

    @Transactional
    public void deleteItemByIdFromParentItem(CartProduct cartProduct) {
        List<CartProduct> cartProducts = cartProductRepository.findAllByCartId(cartProduct.getCart().getId());
        CartProduct cartProductToDelete = null;
        for (CartProduct product : cartProducts) {
            if (product.getProduct().getId() == cartProduct.getProduct().getId() &&
                    product.getColor().getId() == cartProduct.getColor().getId()) {
                cartProductToDelete = product;
            }
        }
        assert cartProductToDelete != null;
        cartProductRepository.deleteByCartIdAndAndColorIdAndAndProductId(
                cartProductToDelete.getCart().getId(), cartProductToDelete.getColor().getId(), cartProductToDelete.getProduct().getId());
    }

    @Override
    public CartDTO updateItem(CartDTO item) {
        cartRepository.save(MapstructMapper.INSTANCE.cartDTOToCart(item));
        return item;
    }

    public CartDTO getCartOfUser(int id) throws InvalidIdException, NotfoundException {
        userService.getItemById(id);
        Cart cart = cartRepository.findCartByUserId(id);
        if (cart == null) {
            throw new NotfoundException(Cart.class);
        }
        return this.getItemById(cart.getId());
    }

    @Transactional
    public void updateCartProduct(CartProduct cartProduct) {
        CartProduct oldCartProduct = cartProductRepository.findByCartIdAndAndProductIdAndColorId(cartProduct.getCart().getId(),
                cartProduct.getProduct().getId(), cartProduct.getColor().getId());
        oldCartProduct.setQuantity(cartProduct.getQuantity());
        cartProductRepository.save(oldCartProduct);
    }

    public CartDTO findCartDTO(Cart cart, int id) throws InvalidIdException {
        if (cart == null) {
            throw new InvalidIdException(Order.class, id);
        }
        List<CartProduct> cartProducts = cartProductRepository.findAllByCartId(id);
        List<OrderAndCartProductDTO> orderAndCartProductDTOS = new ArrayList<>();
        float total_price = 0;
        for (CartProduct cartProduct : cartProducts) {
            int total = cartProduct.getQuantity() * cartProduct.getProduct().getPrice();
            orderAndCartProductDTOS.add(productMapper.productToCartProductDTO(cartProduct, total));
            total_price += total;
        }
        return MapstructMapper.INSTANCE.cartToCartDTO(cart, orderAndCartProductDTOS, total_price);
    }
}
