package ecommercebackend.ecommercebackend.service;

import ecommercebackend.ecommercebackend.entity.database.*;
import ecommercebackend.ecommercebackend.entity.front.FrontProduct;
import ecommercebackend.ecommercebackend.repository.ProductImageRepository;
import ecommercebackend.ecommercebackend.repository.ProductRepository;
import ecommercebackend.ecommercebackend.repository.RatingRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

@Service
@RequiredArgsConstructor
public class ProductService implements CrudService<Product> {

    private final ProductRepository productRepository;
    private final ProductImageRepository productImageRepository;
    private final RatingRepository ratingRepository;
    private final OrderService orderService;


    @Override
    public List<Product> getAllItem() {
        return productRepository.findAll();
    }

    public List<Product> getAllItemByCategoryId(int id) {
//        return productRepository.findAllByCategory(id);
        return null;
    }

    public FrontProduct getCompleteItemById(int product_id) {
        List<ProductImage> productImages = productImageRepository.findByProductId(product_id);

        List<Image> images = new ArrayList<>();
        for (ProductImage productImage : productImages) {
            images.add(productImage.getImage());
        }
        List<Rating> ratings = ratingRepository.findAllByProductId(productImages.get(0).getProduct().getId());

        float averageRate = 0;
        for (Rating rating : ratings) {
            averageRate += rating.getNote();
        }
        averageRate = averageRate / ratings.size();

        return new FrontProduct(
                productImages.get(0).getProduct().getId(),
                productImages.get(0).getProduct().getCategory().getId(),
                productImages.get(0).getProduct().getName(),
                productImages.get(0).getProduct().getDescription(),
                productImages.get(0).getProduct().getStock(),
                productImages.get(0).getProduct().getPrice(),
                ratings,
                averageRate,
                images
        );
    }


    public List<FrontProduct> getCompleteItems() {
        List<ProductImage> productImages = productImageRepository.findAll();
        List<Rating> ratings = ratingRepository.findAll();
        List<FrontProduct> frontProducts = new ArrayList<>();

        for (ProductImage productImage : productImages) {
            if (frontProducts.stream().anyMatch(frontProduct -> frontProduct.getId() == productImage.getProduct().getId())) {
                Optional<FrontProduct> completeProduct = frontProducts.stream()
                        .filter(frontProduct1 -> frontProduct1.getId() == productImage.getProduct().getId())
                        .findFirst();
                completeProduct.ifPresent(product -> product.addImage(productImage.getImage()));
            }
            List<Rating> productRatings = ratings.stream()
                    .filter(rating -> rating.getProduct().getId() == productImage.getProduct().getId())
                    .toList();
            float averageRate = 0;
            for (Rating rating : productRatings) {
                averageRate += rating.getNote();
            }
            averageRate = averageRate / productRatings.size();

            List<Image> images = new ArrayList<>();
            images.add(productImage.getImage());

            frontProducts.add(new FrontProduct(
                    productImages.get(0).getProduct().getId(),
                    productImages.get(0).getProduct().getCategory().getId(),
                    productImages.get(0).getProduct().getName(),
                    productImages.get(0).getProduct().getDescription(),
                    productImages.get(0).getProduct().getStock(),
                    productImages.get(0).getProduct().getPrice(),
                    productRatings,
                    averageRate,
                    images
            ));
        }
        return frontProducts;
    }

    public List<FrontProduct> getBestSellerProduct() {
        List<FrontProduct> frontProducts = this.getCompleteItems();
        List<Order> orders = orderService.getAllItem();
//        for (CompleteProduct completeProduct : completeProducts) {
//            List<Order> myOrders = orders.stream()
//                    .filter(order -> order.getProductId() == completeProduct.getId())
//                    .toList();
//        }
        return null;
    }

    @Override
    public Optional<Product> getItemById(int id) {
        return productRepository.findById(id);
    }

    @Override
    public Product addItem(Product item) {
        return productRepository.save(item);
    }

    @Override
    public void deleteItemById(int id) {
        productRepository.deleteById(id);
    }

    @Override
    public Product updateItem(Product item) {
        return productRepository.save(item);
    }


}
