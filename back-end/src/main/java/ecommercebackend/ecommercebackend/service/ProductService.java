package ecommercebackend.ecommercebackend.service;

import ecommercebackend.ecommercebackend.data.entity.database.Color;
import ecommercebackend.ecommercebackend.data.entity.database.Image;
import ecommercebackend.ecommercebackend.data.entity.database.Product;
import ecommercebackend.ecommercebackend.data.entity.database.Rating;
import ecommercebackend.ecommercebackend.data.repository.ImageRepository;
import ecommercebackend.ecommercebackend.data.repository.ProductColorRepository;
import ecommercebackend.ecommercebackend.data.repository.ProductRepository;
import ecommercebackend.ecommercebackend.data.repository.RatingRepository;
import ecommercebackend.ecommercebackend.dto.ProductDTO;
import ecommercebackend.ecommercebackend.dto.mapper.ProductMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

@Service
@RequiredArgsConstructor
public class ProductService implements CrudService<ProductDTO> {

    private final ProductRepository productRepository;
    private final ProductColorRepository productColorRepository;
    private final ImageRepository imageRepository;
    private final RatingRepository ratingRepository;
    private final ProductMapper productMapper;

    public ProductDTO getItemById(int id) {
        Product product = productRepository.findByIdWithImages(id);
        Color color = productColorRepository.findByProductId(id).getColor();
        List<Rating> ratings = ratingRepository.findAllByProductId(product.getId());
        List<Image> images = imageRepository.findAllByProductId(id);
        product.setImages(images);

        float averageRate = 0;
        int numberOfRate = 0;
        for (Rating rating : ratings) {
            averageRate += rating.getNote();
            numberOfRate++;
        }
        averageRate = averageRate / ratings.size();

        return productMapper.productToProductDto(product, color, numberOfRate, averageRate);
    }

    @Override
    public List<ProductDTO> getAllItem() {
        List<Product> products = productRepository.findAll();
        return this.createDTOs(products);
    }

    @Override
    public ProductDTO addItem(ProductDTO item) {
        productRepository.save(productMapper.productDtoToProduct(item));
        return item;
    }

    @Override
    public void deleteItemById(int id) {
        productRepository.deleteById(id);
    }

    @Override
    public ProductDTO updateItem(ProductDTO item) {
        productRepository.save(productMapper.productDtoToProduct(item));
        return item;
    }


    public List<ProductDTO> getAllItemByCategoryId(int categoryId) throws Exception {
        List<Product> products = productRepository.findAllByCategoryId(categoryId);
        return this.createDTOs(products);
    }

    public List<ProductDTO> createDTOs(List<Product> products) {
        List<Image> images = imageRepository.findAll();
        List<ProductDTO> productDTOS = new ArrayList<>();
        List<Rating> ratings = ratingRepository.findAll();
        //todo une image, pas de couleur, category

        for (Product product : products) {
            List<Rating> productRatings = ratings.stream()
                    .filter(rating -> rating.getProduct().getId() == product.getId())
                    .toList();

            List<Image> productImages = images.stream()
                    .filter(image -> image.getProduct().getId() == product.getId())
                    .toList();

            List<Image> oneImage = new ArrayList<>();
            if (!productImages.isEmpty()) {
                oneImage.add(productImages.get(0));
            }

            float averageRate = 0;
            int numberOfRate = 0;
            for (Rating rating : productRatings) {
                averageRate += rating.getNote();
                numberOfRate++;
            }
            averageRate = averageRate / productRatings.size();
            productDTOS.add(new ProductDTO(
                    product.getId(),
                    null,
                    product.getName(),
                    product.getDescription(),
                    product.getStock(),
                    product.getPrice(),
                    oneImage,
                    null,
                    numberOfRate,
                    averageRate
            ));
        }
        return productDTOS;
    }
}
